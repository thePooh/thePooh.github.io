<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ого, ещё и клип есть?</title>
  <script type="text/javascript">
    function onGoogleAPIReady() {
      gapi.client.setApiKey("AIzaSyCWU3wPW4bt9bIqQWe4ls4eKyy7VKsgs3c");
      gapi.client.load("youtube", "v3");
    }
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
  <script src="https://apis.google.com/js/client.js?onload=onGoogleAPIReady"></script>
  <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
</head>
<body>
  <div id="yt-player">
    You need Flash player 8+ and JavaScript enabled to view this video.
  </div>

  <h3>Enter search query and press Enter</h3>
  <input type="text" id="search-query"/>

  <div class="where_magic_happens">
    <a href="#" id="vk-login">Войти Вконтакте</a>
  </div>

  <script type="text/javascript">
    VMP = {
      setPlayer: function(player) {
        this.ytPlayer = player;
      },
      playVideoByRequest: function(query) {
        var request, player = this.ytPlayer;

        request = gapi.client.youtube.search.list({q: query, part: "id", maxResults: 1, type: "video"});
        request.execute(function(response) {
          var videoId = response.result.items[0].id.videoId;
          player.loadVideoById(videoId);
        });
      },
      fetchSongList: function() {
        var _this = this;
        VK.Api.call('audio.get', {}, function(response) {
          _this.songs = response;
        });
      }
    };

    $(document).ready(function() {
      VK.init({
        apiId: "4797696"
      });
      VK.Auth.getLoginStatus(function(response) {
        if (response.session) {
          console.log("User logged in");
        }
      });

      #("#vk-login").click(function(e) {
        VK.Auth.login(function(response) {
          if (response.session) {
            VMP.fetchSongList();
            $('.where_magic_happens').val(VMP.songs);
          }
        }, 8);
      });

      var params = { allowScriptAccess: "always" };
      var attrs = { id: "yt-player" };
      swfobject.embedSWF("https://www.youtube.com/v/ktvTqknDobU?enablejsapi=1&version=3&controls=0&autoplay=1&fs=1&showinfo=0&modestbranding=1&playerapiid=yt-player",
                         "yt-player", "1000", "620", "8", null, null, params, attrs);

      $("#search-query").keypress(function(e) {
        if ((e.keyCode || e.which) == 13) {
          var input = $(e.target);
          VMP.playVideoByRequest(input.val());
          input.val("");
        }
      });
    });

    function onYouTubePlayerReady(playerId) {
      VMP.setPlayer(document.getElementById("yt-player"));
    }
  </script>
</body>
</html>
