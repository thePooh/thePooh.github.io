<!DOCTYPE html>
<html ng-app="clip-player">
<head>
  <meta charset="UTF-8">
  <title>Ого, ещё и клип есть?</title>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
  <script type="text/javascript">
    function onGoogleAPIReady() {
      gapi.client.setApiKey("AIzaSyCWU3wPW4bt9bIqQWe4ls4eKyy7VKsgs3c");
      gapi.client.load("youtube", "v3");
    }
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
  <script src="https://apis.google.com/js/client.js?onload=onGoogleAPIReady"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
</head>
<body>
  <nav class="navbar navbar-default">
    <div class="container">
      <div class="navbar-header">Круто, ещё и клип есть?</div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-7">
        <div id="yt-player">
          Сначала нужно войти. Если это не поможет - убедитесь, что у вас есть <a href="get.adobe.com/flashplayer">Flash Player</a>.
        </div>
      </div>

      <div class="col-md-5">
        <h3>Enter search query and press Enter</h3>
        <input type="text" id="search-query"/>

        <div class="where_magic_happens">
          <a href="#" id="vk-login">Войти Вконтакте</a>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    VMP = {
      setPlayer: function(player) {
        this.ytPlayer = player;
        this.ytPlayer.addEventListener("onStateChange", "VMP.playerStateChanged");
      },
      playVideoByRequest: function(query) {
        var request, player = this.ytPlayer;

        request = gapi.client.youtube.search.list({q: query, part: "id", maxResults: 1, type: "video"});
        request.execute(function(response) {
          var videoId = response.result.items[0].id.videoId;
          player.loadVideoById(videoId);
        });
      },
      fetchSongList: function() {
        var _this = this;
        VK.Api.call('audio.get', {}, function(response) {
          console.log('Songs loaded');
          _this.songs = response.response;
          $('.where_magic_happens').val(VMP.songs);
        });
      },
      playSong: function(index) {
        var song = this.songs[index];
        this.playVideoByRequest(song.artist + ' ' + song.title);
      },
      nextSong: function() {
        if (this.isRandom) {
          this.playSong(Math.floor(Math.random()*this.songs.length))
        }
      },
      playerStateChanged: function(state) {
        if (state == 0) { // playback stopped
          this.nextSong();
        }
      }
    };

    $(document).ready(function() {
      VK.init({
        apiId: "4797696"
      });

      $("#vk-login").click(function(e) {
        VK.Auth.login(function(response) {
          if (response.session) {
            VMP.fetchSongList();
            var params = { allowScriptAccess: "always", allowFullScreen: true };
            var attrs = { id: "yt-player" };
            swfobject.embedSWF("https://www.youtube.com/apiplayer?enablejsapi=1&version=3&controls=0&autoplay=1&fs=1&showinfo=0&modestbranding=1&playerapiid=yt-player", "yt-player", "100%", "100%", "8", null, null, params, attrs);
          }
        }, 8);
      });

      $("#search-query").keypress(function(e) {
        if ((e.keyCode || e.which) == 13) {
          var input = $(e.target);
          VMP.playVideoByRequest(input.val());
          input.val("");
        }
      });
    });

    function onYouTubePlayerReady(playerId) {
      VMP.setPlayer(document.getElementById("yt-player"));
    }
  </script>
</body>
</html>
